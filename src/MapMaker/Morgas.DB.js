(function(t,e,n){var s,r,i,a,o=n("shortcut")({debug:"debug",det:"Detached"}),l=t.DB=t.DB||{};s=l.Connector=t.Class({init:function(){o.det.detacheAll(this,["save","load","delete","destroy"])},save:function(){throw Error("abstract Class DB.Connector")},load:function(){throw Error("abstract Class DB.Connector")},"delete":function(){throw Error("abstract Class DB.Connector")},destroy:function(){throw Error("abstract Class DB.Connector")},saveChildren:function(t,e){return this.save(t.getChildren(e))},saveFriendships:function(t,e){var n=t.relations[e],r=t.friends[e];if(!r)return o.debug("no friends in relation "+e+" found",2),new o.det.complete(!1);var i=r[0].relations[n.targetRelationName],a=t.getID();if(null==a)return o.debug("friend id is null",2),new o.det.complete(!1);for(var l=[],h=0;r.length>h;h++){var c=r[h].getID();null!=c&&l.push(c)}if(0===l.length)return o.debug("no friend with friend id found"),new o.det.complete(!1);var f=s.getFriendTableName(t.objectType,e,r[0].objectType,n.targetRelationName),d=t.objectType+"_ID",p=r[0].objectType+"_ID",g=[];n.relatedClass===i.relatedClass&&(p+=2);for(var h=0;l.length>h;h++)g.push(new u(f,d,a,p,l[h]));return this.save(g)},loadParent:function(t,e){var n=t.relations[e],s=n.relatedClass,r=n.fieldName;return this.load(s,{ID:t.getValueOf(r)}).then(function(n){var s=n[0];s.addChild(e,t),this.complete(s)})},loadChildren:function(t,e,n){var s=t.relations[e],r=rel.relatedClass,i=s.fieldName;return n[i]=this.getID(),this.load(r,n).then(function(e){t.addChildren(e),this.complete(e)})},loadFriends:function(t,e,n){var r=this,i=t.relations[e],a=i.relatedClass,l=(new a).relations[i.targetRelationName],h=t.objectType+"_ID",c=a.prototype.objectType+"_ID",f=s.getFriendTableName(t.objectType,e,a.prototype.objectType,i.targetRelationName),d={};i.relatedClass===l.relatedClass&&(c+=2),d[h]=t.getID();var p=u.Generator(f,h,c),g=this.load(p,d);return i.relatedClass===l.relatedClass&&(g=g.then(function(t){var e=this;d[c]=d[h],delete d[h],r.load(p,d).then(function(n){for(var s=0;n.length>s;s++){var r=n[s].fields[h].value;n[s].fields[h].value=n[s].fields[c].value,n[s].fields[c].value=r}e.complete(t.concat(n))},o.debug)},o.debug)),g.then(function(t){return n.ID=t.map(function(t){return t.fields[c].value}),r.load(a,n)},o.debug)},deleteFriendships:function(t,e){var n=t.relations[e],r=t.friends[e];if(!r)return o.debug("no friends in relation "+e+" found",2),new o.det.complete(!1);var i=r[0].relations[n.targetRelationName],a=t.getID();if(null==a)return o.debug("friend id is null",2),new o.det.complete(!1);for(var l=[],h=0;r.length>h;h++){var c=r[h].getID();null!=c&&l.push(c)}if(0===l.length)return o.debug("no friend with friend id found"),new o.det.complete(!1);var f=s.getFriendTableName(t.objectType,e,r[0].objectType,n.targetRelationName),d=t.objectType+"_ID",p=r[0].objectType+"_ID",g=[];if(n.relatedClass===i.relatedClass){p+=2;var v={};v[d]=l,v[p]=a,g.push(v)}var v={};v[d]=a,v[p]=l,g.push(v);for(var y=[],m=u.Generator(f,d,p),h=0;g.length>h;h++)y.push(this["delete"](m,g[h]));return new o.det(y)}}),s.sortObjs=function(t){for(var e={friend:{},fresh:{},preserved:{}},n=0;t.length>n;n++){var s=t[n],r=s instanceof u?"friend":void 0===s.getID()?"fresh":"preserved",i=s.objectType;void 0===e[r][i]&&(e[r][i]=[]),e[r][i].push(s)}return e},s.getDeletePattern=function(t,e){var n=typeof e;if(("number"===n||e instanceof l.Object)&&(e=[e]),Array.isArray(e)){for(var s=0;e.length>s;s++)e[s]instanceof t&&(e[s]=e[s].getID());e={ID:e}}return e},s.getFriendTableName=function(t,e,n,s){return[t,e,n,s].sort().join("_")},e("DBConn",s),r=l.Object=t.Class({objectType:null,init:function(t){if(t=t||{},null==this.objectType)throw"DB.Object: objectType not defined";this.fields={},this.relations={},this.parents={},this.children={},this.friends={},this.addField("ID",a.TYPES.INT,t.ID,{UNIQUE:!0,AUTOGENERATE:!0})},addRelation:function(t,e,n,s,r){this.relations[t]=new i(e,n,s||t,r)},addField:function(t,e,n,s){this.fields[t]=new a(e,n,s)},getValueOf:function(t){return this.fields[t].getValue()},setValueOf:function(t,e){"ID"!=t&&this.fields[t].setValue(e)},setID:function(t){this.fields.ID.setValue(t);for(var e in this.children)for(var n=this.children[e],s=0;n.length>s;s++)n[s]._setParent(this.relations[e],this)},getID:function(){return this.getValueOf("ID")},getParent:function(t){return this.parents[t]},_setParent:function(t,e){var n=this.relations[t.targetRelationName];this.parents[t.targetRelationName]=e,this.setValueOf(n.fieldName,e.getValueOf(t.fieldName))},_add:function(t,e,n){var s=t[e]=t[e]||[];-1==s.indexOf(n)&&s.push(n)},_get:function(t,e){return(t[e]||[]).slice(0)},addChild:function(t,e){this.relations[t].type==i.TYPES.CHILD&&(this._add(this.children,t,e),e._setParent(this.relations[t],this))},addChildren:function(t,e){for(var n=0;e.length>n;n++)this.addChild(t,e[n])},getChildren:function(t){return this._get(this.children,t)},addFriend:function(t,e){this.relations[t].type==i.TYPES.FRIEND&&(this._add(this.friends,t,e),e._add(e.friends,this.relations[t].targetRelationName,this))},addFriends:function(t,e){for(var n=0;e.length>n;n++)this.addFriend(t,e[n])},getFriends:function(t){return this._get(this.friends,t)},toJSON:function(){var t={};for(var e in this.fields)t[e]=this.fields[e].toJSON();return t},fromJSON:function(t){for(var e in this.fields)void 0!==t[e]&&this.fields[e].fromJSON(t[e]);return this},toString:function(){return JSON.stringify(this)}}),e("DBObj",r);var u=l.Firendship=t.Class({init:function(t,e,n,s,r){this.objectType=t,this.fields={},this.fields[e]=new a(a.TYPES.INT,n),this.fields[s]=new a(a.TYPES.INT,r)},toJSON:r.prototype.toJSON,fromJSON:r.prototype.fromJSON});u.Generator=function(e,n,s){return t.Class(u,{objectType:e,init:function(){this.superInit(u,e,n,null,s,null)}})},e("DBFriend",u),i=l.Relation=t.Class({init:function(t,e,n,s){if(null==s){if(e==i.TYPES.PARENT)throw"DB.Relation: "+e+" relation needs a fieldName";s="ID"}this.type=e,this.relatedClass=t,this.fieldName=s,this.targetRelationName=n}}),i.TYPES={PARENT:-1,FRIEND:0,CHILD:1},e("DBRel",i),a=l.Field=t.Class({init:function(t,e,n){this.type=t,this.value=e,this.options=n||{}},setValue:function(t){this.value=t},getValue:function(){return this.value},toJSON:function(){switch(this.type){case a.TYPES.DATE:var t=this.getValue();if(t instanceof Date)return t.getUTCFullYear()+","+t.getUTCMonth()+","+t.getUTCDate()+","+t.getUTCHours()+","+t.getUTCMinutes()+","+t.getUTCSeconds()+","+t.getUTCMilliseconds();break;default:return this.getValue()}},fromJSON:function(t){switch(this.type){case a.TYPES.DATE:this.value=new Date(Date.UTC.apply(Date,t.split(",")));break;default:this.value=t}},toString:function(){return JSON.stringify(this)},fromString:function(t){switch(this.type){case a.TYPES.BOOL:this.value=!!~~t;break;case a.TYPES.INT:this.value=~~t;break;case a.TYPES.DOUBLE:this.value=1*t;break;case a.TYPES.DATE:this.fromJSON(JSON.parse(t));break;case a.TYPES.STRING:case a.TYPES.JSON:default:this.value=JSON.parse(t)}}}),a.TYPES={BOOL:0,INT:1,DOUBLE:2,STRING:3,DATE:4,JSON:5,BLOB:6},e("DBField",a)})(Morgas,Morgas.setModule,Morgas.getModule);